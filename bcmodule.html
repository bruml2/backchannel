<!DOCTYPE html>
<!--  Wed May 4: 7 hours;
      Thu May 5: 6 hours;
      Fri May 6: x hours;
-->
<html>
<head>
  <title>FinalsClub</title>
  <script src="http://code.jquery.com/jquery-1.6.min.js"></script>
  <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
  <script src="http://cdn.socket.io/stable/socket.io.js"></script>
  <script>
    // We need a Post object (modelled on EtherPad):
    //  [the schoolid and courseid are implied in the meetingid];
    var dummyPost = { 
      objtype: "post",
      meetingid: 888,
      userid: 12345,
      username: "Bill Jones",
      useraffil: "student",
      postid: 999,
      body: "This question is the body of the post?",
      posvotes: 1,
      negvotes: 1,
      isdeleted: false,
      ispromoted: false,
      isdemoted: false,
      created: "2011-05-04 14:35:21" };
    var arrayOfPosts = [ dummyPost, dummyPost, dummyPost ];

    var currMeetingID = "9876";
    var userObj = { userID: null, userName: null, userAffil: null };
    function setUserNameAndAffil() {
      // add the real code to do this:
      userObj.userID = "1234";
      userObj.userName = "Beardsley";
      userObj.userAffil = "student";
    }
    
    var socket = null;
    function assembleNewPostObj(msgBody) {
      // the postid is assigned at the server;
      var postObj = { objtype: "post", postid: null,
                      posvotes: 0, negvotes: 0, isdeleted: false,
                      ispromoted: false, isdemoted: false };
      postObj.meetingid = currMeetingID;
      postObj.userid    = userObj.userID;
      postObj.username  = userObj.userName;
      postObj.useraffil = userObj.userAffil;
      postObj.timeofpost = (new Date).getTime();
      postObj.body = msgBody;
      return postObj;
    }
    function renderArrayOfTopPostsToScreen(arrayOfPosts) {
      $('#topPosts .topPostContainer').remove();
      $("#topPostTemplate").tmpl(arrayOfPosts).appendTo("#topPosts");      
    }
    // this function needs work;
    function renderArrayOfRecentPostsToScreen(arrayOfPosts) {
      $('#recentPosts .topPostContainer').remove();
      $("#recentPostTemplate").tmpl(arrayOfPosts).appendTo("#recentPosts");      
    }
    $(document).ready(function(){
      // fill in holes;
      setUserNameAndAffil();
      $('.userName').text(userObj['userName']);
      $('.userAffil').text(userObj['userAffil']);
      // add event handlers;
      $('#backchatHeader input[type="button"]').click(function() {
        $('#backchatHeaderInstructions').toggle(500);
      });
      $('#enterPostTextarea').keyup(function() {
        var charLimit = 250;
        var charsUsed = $(this).val().length;
        if (charsUsed > 4) {
          $('#charsLeftMsg').text("characters left: " + 
            (charLimit - charsUsed).toString());
        } else {
          $('#charsLeftMsg').text(" ");

        }
      });
      // this is just temporary for testing;
      $('#replaceTopPosts').click(function() {
        renderArrayOfTopPostsToScreen(arrayOfPosts);
      });
      $('#submitPost').click(function() {
        var newPostObj = assembleNewPostObj($('#enterPostTextarea').val());
        // TODO: may have to substitute "<br />" for newlines;
        $('#debugDisplay .newpost').remove();
        $('#debugDisplay').append('<p class="newpost">NEW POST: ' + newPostObj.body + '</p>');
        // can the data be an object?  WebSockets wants a string;
        // socket.send(JSON.stringify(newPostObj));
        socket.send(newPostObj);
        $('#enterPostTextarea').val('');
      });
      // create socket to server;
      socket = new io.Socket(null, {port: 8080, rememberTransport: false});
      // incoming messages are data for the Top Posts section or data for
      // the Recent Posts section; in either case, the message object has one
      // property ("topPosts" or "recentPosts") whose value is an array of Post
      // objects.  Probably will not send vote messages but rather new arrays of
      // posts with updated vote counts.
      socket.on('message', function(obj) {
        $('#debugDisplay').append('<p>MESSAGE arrived</p>');
        if ('topPosts' in obj){
          renderArrayOfTopPostsToScreen(arrayOfPosts)
        } else if ('recentPosts' in obj) {
          renderArrayOfRecentPostsToScreen(arrayOfPosts)
        } else if ('vote' in obj) {
          // TODO: write recordVote();
          // recordVote(obj['vote']);
        } else {
          $('#debugDisplay').append('<p>Unknown message type received on socket</p>');
        }
      });
      socket.on('connect', function(){ 
        $('#debugDisplay').append('<p>SOCKET connected!</p>');
      });
      socket.on('disconnect', function(){ 
        $('#debugDisplay').append('<p>SOCKET disconnected!</p>');
      });
      // =============>  NB!! <==============
      socket.connect();

      $('#debugDisplay').append('<p>SOCKET created on port ' + 
                                 socket.options.port + '</p>');

      $('#enterPostTextarea').val("So this is the text of the first message " +
            "helpfully automatically placed in the textarea!");
    }); // (document).ready();
  </script>
  <style>
body {
  font: "ComicSans" sans-serif;
  font-size: 100%;
  background-color: #fff1c5;
  margin: 0;
  padding: 0;
}
#container {
  margin: 2em;
  padding: 2em;
  border: 2px solid green;
}
/*========================*/
#notesContainer {
  min-height: 30em;
  float: left;
  width: 25%;
}
#notesHeader { 
  padding: 0.8em;
  border: 2px solid #ddd;
}
.courseTitle { font: bold 1.6em Palatino, "Times New Roman", Times, serif; }
.lectureDesc { font: bold 1.3em Palatino, "Times New Roman", Times, serif; }
#notesComponent {
  margin-top: 4em;
  padding: 0.8em;
  border: 2px solid #ddd;
  text-align: center;
}
/*========================*/
#backchat {
  min-height: 30em;
  margin-left: 30%;
  border: 2px solid blue;
  background-color: wheat;
}
#backchatHeader {
  font-weight: bold;
  padding: 0.5em 0.8em;
  background-color: #DDD;
  border-bottom: 2px solid black;
}
#backchatHeader input { font-size: 0.7em; }
#backchatHeaderInstructions {
  display: none;
  /* example combo: font:italic bold 12px/30px Georgia, serif; */
  font: 1.2em "Times New Roman", Times, serif;
  background-color: #EEE;
  padding: 1em;
}
#backchatHeaderInstructions p {
  text-indent: 1em;
  margin-top: 0.2em;
}
/*========================*/
#userBox {
  position: relative; /* allow position absolute for charsLeftMsg and submit btn */
  padding: 1.3em;
  border-bottom: 3px solid black;
  background-color: lavender;
}
#userHeader {

}
#userHeader .userName { 
  font: bold 1.3em Palatino, "Times New Roman", Times, serif;
}
#userHeader .userAffil {
  font: italic 1em Palatino, "Times New Roman", Times, serif;
  margin-left: 1.5em;
}
#userButtons {
  float: right;
}
#enterPostTextarea {
  font-family: "frutiger linotype","lucida grande","verdana",sans-serif;
  font-size: 100%;
  border: 4px solid green; /*#D3CAEB; */
  display: block;
  width: 98%;
  margin: 1.2em 0 2em 0;
  padding: 0.3em 0.4em;
}
#charsLeftMsg {
  position: absolute;
  left: 3em;
  bottom: 1.5em;
  color: red; 
}
#submitPost {
  position: absolute;
  right: 1.5em;
  bottom: 1.5em;
}
#enterUser { display: none; }
#enterAdmin { display: none; }
#topPosts {
  min-height: 6em;
  border-bottom: 3px solid black;
  padding: 1em 1.5em;
}
#topPostsHeader {
  padding-bottom: 0.5em;
}
#recentPosts {
  min-height: 6em;
  padding: 1em 1.5em;
}
#topPosts .topPostContainer {
  border-top: 2px solid #333;
  min-height: 5.3em;
  background-color: #EEE;
}
#topPosts .postVoteContainer {
  float: left;
}
#topPosts .postVoteContainer .vote-tally-rect {
	width: 1.6em;
	height: 1em;
	border: 1px solid #444;
	-moz-border-radius: 6px;
	margin: 0.3em;
	padding: 0.2em;
	font-size: 1.3em;
	text-align: right;
}
#topPosts .postVoteContainer .vote-up-rect {
	background: transparent url(images/arrow_up.png) no-repeat scroll 10% 50%;
}
#topPosts .postVoteContainer .vote-dn-rect {
	background: transparent url(./images/arrow_dn.png) no-repeat scroll 10% 50%;
}
#topPosts .postDisplayContainer {
	margin: 0.3em 0.3em 0.3em 4em;
}
#topPosts .postBody {
  min-height: 2.7em;
  border-left:  1px solid #D3CAEB;
  border-top:   1px solid #D3CAEB;
  border-right: 1px solid #D3CAEB;
  font: 1em/1.2em Palatino, "Times New Roman", Times, serif;
  overflow: hidden;
  padding: 0.2em;
}
#topPosts .postFooter {
  background-color: #D3CAEB;
  color: #111111;
  padding-left: 0.6em;
}
#topPosts .userName {
  font: bold 1em Helvetica, sans-serif;
}
#topPosts .userAffil {
  font: italic 1em Helvetica, sans-serif;
}
  </style>
</head>

<body>
<div id="container">
<div id="notesContainer">
  <div id="notesHeader">
    <div class="courseTitle">The Human Mind</div>
    <div class="lectureDesc">Lecture #6: April 3, 2001: Evolution</div>
  </div>
  <div id="notesComponent">EtherPad component goes here!</div>

  <!-- temporary -->
  <div id="debugDisplay"
       style="margin-top: 4em; 
              padding: 0.8em; 
              border: 2px solid #ddd; 
              text-align: center;">
    <input type="button" id="replaceTopPosts" value="Replace Top Posts" />
  </div>

</div><!-- notesContainer -->

<div id="backchat">
<div id="backchatHeader">
  Share your reactions:&nbsp;&nbsp;
  <input type="button" value="show instructions" />
</div>

<div id="backchatHeaderInstructions">
  <p>Use this section to react to the lecture: your posts will be seen by others <strong>immediately</strong>, and they can <strong>respond</strong> or <strong>vote your post up or down</strong>. Your post can be a <strong>question</strong>, <strong>comment</strong>, <strong>link to something related to the lecture</strong>, or whatever else you think other people might be interested in.</p>
  <p>Even if you don't have anything to say, you can <strong>vote posts up or down</strong> that you think are useful or problematic. Highly ranked and comments will be brought to the lecturer's attention.</p>
</div><!-- headerInstructions -->

<div id="userBox">
  <div id="userHeader">
    <span class="userName"></span>
    <span class="userAffil"></span>
    <div id="userButtons">
      <input type="button" id="editUser" value="Edit User" />
      <input type="button" id="adminPassword" value="Admin" />
    </div>
  </div>

  <div id="enterUser">
    <div class="hd">Who are you?</div>
    <div class="bd">
      <form id="userAddForm" method="POST" action="/users/add">
        <table>
          <tr>
            <td><label for="name">Name:</label></td>
            <td>
                        <input type="text" id="UserName"
                            name="data[User][name]" value=""
                            maxlength="28" size="20" />
            </td>
          </tr>
          <tr>
            <td><label for="affiliation">Affiliation:</label></td>
            <td>
                <input type="text" id="UserAffiliation"
                    name="data[User][affiliation]" value=""
                    maxlength="48" size="20" />
            </td>
          </tr>
        </table>
      </form>
    </div>
  </div><!-- enterUser -->

  <div id="enterPost">
    <form id="enterPostForm">
      <!-- onkeyup for cut or copy&paste, onkeypress for hold key down -->
      <textarea id="enterPostTextarea" name="data[Post][body]"></textarea>
      <div id="charsLeftMsg">&nbsp;</div>
      <input type="hidden" id="hostMeetingId"
              name="data[Post][meeting_id]"
              value="926" />
      <input type="button" id="submitPost"
             name="submitPost" value="Submit Post" />
    </form>
  </div><!-- enterPost -->

</div><!-- userBox -->

<div id="topPosts">
  <div id="topPostsHeader">
    <span id="maxTopPosts">6</span> Highest Rated Posts:
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <input type="button" id="chgTopLimit" value="change number displayed" />
  </div>
  
  
</div>

<div id="recentPosts">
  <div id="recentPostsHeader">
    <span id="maxRecentPosts">6</span> Most Recent Posts:
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <input type="button" id="chgRecentLimit" value="change number displayed" />
  </div>
  <!-- recentPostContainers will be added here -->
</div>
    
</div> <!-- backchat -->
</div> <!-- container -->
<div id="hiddenTopPosts" style="display: none; ">
  <!-- repeated for each top post; -->
  <div class="topPostContainer">
    <div class="postVoteContainer">
      <div class="vote-tally-rect vote-up-rect">5</div>
      <div class="vote-tally-rect vote-dn-rect">2</div>
    </div>
    <div class="postDisplayContainer">
      <div class="postBody">The body of the post may ask a question?</div> 
      <div class="postFooter">
        <span class="userName">Sammy</span>&nbsp;&nbsp;&nbsp;
        <span class="userAffil">student</span>
      </div> 
    </div>
  </div><!-- topPostContainer -->
  
  <!-- repeated for each top post; -->
  <div class="topPostContainer">
    <div class="postVoteContainer">
      <div class="vote-tally-rect vote-up-rect">5</div>
      <div class="vote-tally-rect vote-dn-rect">2</div>
    </div>
    <div class="postDisplayContainer">
      <div class="postBody">The body of the post may ask a very good question?</div> 
      <div class="postFooter">
        <span class="userName">George</span>&nbsp;&nbsp;&nbsp;
        <span class="userAffil">student</span>
      </div> 
    </div>
  </div><!-- topPostContainer -->
</div>
<!-- these templates are used to generate Top Posts from an array received from
     the server. The unknown mime type causes the browser to ignore it -->
<script id="topPostTemplate" type="text/x-jQuery-tmpl">
  <div class="topPostContainer">
    <div class="postVoteContainer">
      <div class="vote-tally-rect vote-up-rect">${posvotes}</div>
      <div class="vote-tally-rect vote-dn-rect">${negvotes}</div>
    </div>
    <div class="postDisplayContainer">
      <div class="postBody">${body}</div> 
      <div class="postFooter">
        <span class="userName">${username}</span>
        <span class="userAffil">${useraffil}</span>
      </div> 
    </div>
  </div>
</script>
<script id="recentPostTemplate" type="text/x-jQuery-tmpl">
  <div class="recentPostContainer">
    <div class="postVoteContainer">
      <div class="vote-tally-rect vote-up-rect">${posvotes}</div>
      <div class="vote-tally-rect vote-dn-rect">${negvotes}</div>
    </div>
    <div class="postDisplayContainer">
      <div class="postBody">${body}</div> 
      <div class="postFooter">
        <span class="userName">${username}</span>&nbsp;&nbsp;&nbsp;
        <span class="userAffil">${useraffil}</span>
      </div> 
    </div>
  </div>
</script>
</body>
</html>